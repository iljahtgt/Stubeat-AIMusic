<!DOCTYPE html>
<html>

<head>

    <%- include('../../partials/header') -%>
        <%- include('../../partials/styles') -%>
            <style>
                h1 {
                    text-align: center;
                    font-family: 'Lobster', cursive;
                    font-size: 4vw;
                }

                .form-group {
                    width: 30%;
                    margin: 20px auto;
                }

                .card {
                    width: 30%;
                    height: 50px;
                    margin: 10px auto;
                }

                .btns {
                    width: 50%;
                    margin: 10px auto;
                    text-align: center;
                }

                input#addusername,
                input#addpassword {
                    width: 100%;
                }

                span.errorMes {
                    font-size: 12px;
                    color: red;
                }
            </style>
</head>

<body>
    <%- include('../../partials/navbar.ejs') -%>
        <%- include('../../partials/scripts') -%>
            <h1>Login</h1>

            <div class="formDiv">
                <div class="form-group">
                    <label for="email">Email: </label>
                    <input class="form-control" type="email" id="email" name="email" placeholder="Enter email"
                        autocomplete="off" required />
                </div>
                <div class="form-group">
                    <label for="pwd">Password: </label>
                    <input class="form-control" type="password" id="pwd" name="pwd" required />
                </div>
                <div class="form-group">
                    <div class="btns">
                        <button class="btn btn-primary" id="loginBtn">ç™»å…¥</button>
                        <button type="button" class="btn btn-primary" data-toggle="modal"
                            data-target="#addMem">è¨»å†Š</button>
                        <div class="messSpan alert-danger" id="errorMessage" style="margin-top: 10px;"></div>
                    </div>

                </div>

                <!-- addMem -->
                <div class="modal fade" id="addMem" data-backdrop="static" data-keyboard="false" tabindex="-1"
                    aria-labelledby="staticBackdropLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">è¨»å†Šæœƒå“¡</h3>
                            </div>
                            <div class="modal-body">
                                <div class="container">
                                    <div class="form-group">
                                        <label for="addusername">ä½¿ç”¨è€…åç¨±ï¼š</label>
                                        <input id="addusername" name="username" type="text" class="form-control"
                                            required>
                                        <span class="errorMes" id="nameMessage"></span>
                                    </div>
                                    <div class="form-group">
                                        <label for="addemail">ä½¿ç”¨è€…ä¿¡ç®±ï¼š</label>
                                        <input id="addemail" name="email" type="email" class="form-control" required>
                                        <span class="errorMes" id="emailMessage"></span>
                                    </div>
                                    <div class="form-group">
                                        <label for="addpassword">ä½¿ç”¨è€…å¯†ç¢¼ï¼š</label>
                                        <input id="addpassword" name="password" type="password" size="6"
                                            class="form-control" required>
                                        <span class="errorMes" id="idsp"></span>
                                        <div class="tip">(1.è‹±æ•¸æ··åˆ 2.6ä½æ•¸ä»¥ä¸Š)</div>
                                        <button class="btn btn-primary" id="signupBtn" type="submit">è¨»å†Š</button>
                                        <button type="reset" class="btn btn-success">Reset</button>
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script>

                    var emailFlag = false;

                    // login
                    $("#loginBtn").click(function () {
                        var email = $("#email").val();
                        var password = $("#pwd").val();
                        if (email && password) {
                            var loginInfo = {
                                email: email,
                                password: password,
                            };
                            $.ajax({
                                type: "post",
                                url: "http://localhost:1337/api/login",
                                data: JSON.stringify(loginInfo),
                                contentType: "application/json;charset=utf-8",
                            })
                                .done(function (result) {
                                    localStorage.clear();
                                    if (result.length == 0) {
                                        $("#errorMessage").html("æœƒå“¡ä¸å­˜åœ¨");
                                    }
                                    console.log(result[0]);
                                    localStorage.setItem("loginStatus", true);
                                    localStorage.setItem("userid", result[0].id);
                                    localStorage.setItem("username", result[0].username);
                                    localStorage.setItem("useremail", result[0].email);
                                    window.location.href = "/";
                                })
                                .fail(function (err) {
                                    alert("Error: " + err);
                                });
                        } else {
                            alert("è«‹å¡«ç™»å…¥è³‡è¨Š");
                        }
                    });

                    // sign up
                    $('#signupBtn').click(function () {
                        var username = $('#addusername').val();
                        var email = $('#addemail').val();
                        var password = $('#addpassword').val();
                        if (username && email && password && emailFlag) {
                            var newUser = {
                                username: username,
                                email: email,
                                password: password
                            };
                            $.ajax({
                                type: 'post',
                                url: 'http://localhost:1337/api/signup',
                                data: JSON.stringify(newUser),
                                contentType: 'application/json;charset=utf-8'
                            }).done(function (result) {
                                // console.log(result);
                                alert('Welcome to StuBeats');
                                window.location.href = '/account/login';
                            }
                            ).fail(function (err) {
                                alert('Error: ' + err.errorText);
                            })
                        } else {
                            alert("æ¬„ä½æœ‰å•é¡Œ");
                        };
                    })


                    // check password format
                    document.getElementById("addpassword").onblur = checkPwd;
                    function checkPwd() {
                        //å–å¾—addpasswordå…ƒç´ 
                        let thePwdObj = document.getElementById("addpassword");//æ‹¿åˆ°æ¬„ä½ï¼©ï¼¤
                        console.log(typeof thePwdObj);
                        //å–å¾—addpasswordå…ƒç´ å€¼
                        let thePwdObjVal = thePwdObj.value;//æ‹¿åˆ°æ¬„ä½å€¼
                        console.log(typeof thePwdObjVal);
                        console.log(thePwdObjVal);
                        //åˆ¤æ–·å…ƒç´ å€¼æ˜¯å¦ç‚ºç©ºç™½ï¼Œå¯†ç¢¼é•·åº¦æ˜¯å¦å¤§æ–¼6
                        //å¦‚æœé•·åº¦æ˜¯å¦å¤§æ–¼6ï¼Œåˆ¤æ–·æ˜¯å¦åŒ…å«å­—æ¯ã€æ•¸å­—ã€ç‰¹æ®Šç¬¦è™Ÿ
                        let sp = document.getElementById("idsp");
                        let thePwdObjValLen = thePwdObjVal.length;//æ‹¿åˆ°è¼¸å…¥å…§å®¹é•·åº¦
                        let flag1 = false, flag2 = false, flag3 = false;
                        if (thePwdObjVal == "")
                            sp.innerHTML = "ä¸å¯ç©ºç™½";

                        // sp.innerHTML = "you need enter";
                        else if (thePwdObjValLen >= 6) {

                            sp.innerHTML = ">=";
                            for (let i = 0; i < thePwdObjValLen; i++) {
                                let ch = thePwdObjVal.charAt(i).toUpperCase();
                                if (ch >= "A" && ch <= "Z")
                                    flag1 = true;
                                //else if()
                                if (flag1) break;
                            }
                            for (let o = 0; o < thePwdObjValLen; o++) {
                                let num = thePwdObjVal.charAt(o);
                                if (num >= 0 && num <= 9)
                                    flag2 = true;
                                if (flag2) break;
                            }
                            if (flag1 && flag2)
                                sp.innerHTML = "ğŸ‘";
                            else if (flag1)
                                sp.innerHTML = "âŒ ç¼ºå°‘æ•¸å­—";
                            else if (flag2)
                                sp.innerHTML = "âŒ ç¼ºå°‘è‹±æ–‡";
                        } else {
                            sp.innerHTML = "âŒ éœ€è¦6å€‹ä»¥ä¸Šçš„å­—å…ƒ";
                        }
                    }

                    // chack if email already exists
                    $('#addemail').blur(function () {
                        var emailCheck = $('#addemail').val();
                        if (emailCheck === '') {
                            $('#emailMessage').html('ä¸å¯ç©ºç™½');
                            emailFlag = false;
                        } else {
                            var data = { email: emailCheck }
                            $.ajax({
                                type: 'post',
                                url: 'http://localhost:1337/api/emailCheck',
                                data: JSON.stringify(data),
                                contentType: 'application/json;charset=utf-8'
                            }).done(function (res) {
                                if (res.length > 0) {
                                    $('#emailMessage').html('æœƒå“¡å·²å­˜åœ¨');
                                    emailFlag = false;
                                } else {
                                    $('#emailMessage').html('ğŸ‘')
                                    emailFlag = true;
                                }
                            }).fail(function (err) {
                                alert(JSON.stringify(err));
                            });
                        }
                    })

                    // check usename
                    $('#addusername').blur(function () {
                        if ($('#addusername').val() === '') {
                            $('#nameMessage').html('ä¸å¯ç©ºç™½');
                        } else {
                            $('#nameMessage').html('ğŸ‘')
                        }
                    })


                </script>
</body>

</html>